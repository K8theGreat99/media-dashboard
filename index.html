<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindful Media Dashboard</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --background: #ecf0f1;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --border: #bdc3c7;
            --success: #27ae60;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--secondary);
            position: relative;
        }

        h1 {
            font-size: 2.5em;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.2em;
            color: var(--text-light);
            font-style: italic;
        }

        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-light);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: var(--border);
            color: var(--text);
        }

        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        h2 {
            font-size: 1.8em;
            color: var(--primary);
        }

        .refresh-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .refresh-btn:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        /* Currently Reading Section */
        .reading-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .book-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }

        .book-card h3 {
            margin-bottom: 5px;
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .book-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .book-link {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .book-link:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .add-book-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .add-book-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .modal-content p {
            margin-bottom: 15px;
            color: var(--text-light);
            font-size: 0.95em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #95a5a6;
        }

        .btn-danger {
            background: var(--accent);
            color: white;
            font-size: 0.85em;
            padding: 8px 16px;
            margin-top: 10px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Content Feed Items */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .content-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .content-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .content-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .content-card-body {
            padding: 15px;
        }

        .content-card h3 {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: var(--primary);
            line-height: 1.4;
        }

        .content-card a {
            color: var(--primary);
            text-decoration: none;
        }

        .content-card a:hover {
            color: var(--secondary);
        }

        .content-meta {
            color: var(--text-light);
            font-size: 0.85em;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
            font-style: italic;
        }

        .error {
            background: #ffe6e6;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .api-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 10px;
            vertical-align: middle;
        }

        .api-status.configured {
            background: #d4edda;
            color: #155724;
        }

        .api-status.missing {
            background: #fff3cd;
            color: #856404;
        }

        .cache-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.85em;
            color: var(--text-light);
        }

        .cache-time {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .refresh-counter {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 4px;
            background: #d4edda;
            color: #155724;
        }

        .refresh-counter.warning {
            background: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <button class="settings-btn" onclick="openApiKeyModal()">‚öôÔ∏è Settings</button>
            <h1>üìö Mindful Media Dashboard</h1>
            <p class="tagline">Intentional content, curated by you</p>
        </header>

        <!-- Currently Reading/Listening Section -->
        <section class="section">
            <div class="section-header">
                <h2>Currently Reading & Listening</h2>
            </div>
            <div class="reading-grid" id="reading-grid">
                <!-- Books will be added here -->
            </div>
            <button class="add-book-btn" onclick="openBookModal()">+ Add Book/Audiobook</button>
        </section>

        <!-- YouTube Section -->
        <section class="section">
            <div class="section-header">
                <h2>üì∫ Latest from YouTube <span id="youtube-api-status" class="api-status"></span></h2>
                <div class="cache-info">
                    <span class="cache-time" id="cache-time">Last updated: Never</span>
                    <span class="refresh-counter" id="refresh-counter">Refreshes today: 0/3</span>
                </div>
                <button class="refresh-btn" onclick="refreshYouTube()" id="youtube-refresh">Refresh</button>
            </div>
            <div id="youtube-content">
                <div class="loading">Loading videos...</div>
            </div>
        </section>

        <!-- Substack Section -->
        <section class="section">
            <div class="section-header">
                <h2>‚úçÔ∏è Latest from Substack</h2>
                <button class="refresh-btn" onclick="refreshSubstack()" id="substack-refresh">Refresh</button>
            </div>
            <div id="substack-content">
                <div class="loading">Loading articles...</div>
            </div>
        </section>
    </div>

    <!-- Add/Edit Book Modal -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <h3 id="book-modal-title">Add Book/Audiobook</h3>
            <form id="bookForm">
                <div class="form-group">
                    <label for="platform">Platform</label>
                    <select id="platform" required>
                        <option value="Audible">Audible</option>
                        <option value="Kindle">Kindle</option>
                        <option value="Kobo">Kobo</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="title">Book Title</label>
                    <input type="text" id="title" required placeholder="Enter book title">
                </div>
                <div class="form-group">
                    <label for="url">URL (link to book page)</label>
                    <input type="url" id="url" required placeholder="https://...">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeBookModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
            <button class="btn btn-danger" id="deleteBtn" style="display: none;" onclick="deleteCurrentBook()">Delete
                Book</button>
        </div>
    </div>

    <!-- API Key Setup Modal -->
    <div class="modal" id="apiKeyModal">
        <div class="modal-content">
            <h3>üîë YouTube API Key Setup</h3>
            <p>Enter your YouTube Data API v3 key to enable the video feed. This will be stored locally in your browser
                and is never sent anywhere except to YouTube's API.</p>
            <form id="apiKeyForm">
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="text" id="apiKey" required placeholder="AIzaSy...">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeApiKeyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save API Key</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - YOUR PERSONALIZED SETTINGS
        // ============================================

        const CONFIG = {
            // Your YouTube Channel IDs
            youtubeChannels: [
                'UC8JOgFXp-I3YV6dsKqqQdUw',  // Caroline Winkler
                'UC13w4dxfIGf_MM2qtyJ1aSA',  // Christy Anne Jones
                'UCC0FFiHb6mSNKf4h455G0Gw',  // Everyday People do Business and Money
                'UCnhpSiQ1iBJbt_euYU9myxA',  // Anna Howard
                'UCk9Nz_upeYXu2DpEvs1HajQ',  // Snapdragon Life
                'UCvnSyOfwtn7J14CYRbCaveQ',  // Rajiv Surendra
                'UCSHtaUm-FjUps090S7crO4Q',  // Bernadette Banner
                'UCoydhtfFSk1fZXNRnkGnneQ',  // ESOTERICA
                'UCSwwoUNvQWgZDC8a_O6Qs_A',  // Kaz Rowe
                'UCgz4oLdeKP1Pt2BpiUn2iXQ',  // V. Birchwood
                'UCca-WkVPVe9nzs2iFct4wxg',  // Nicole Rudolph
                'UC-SrCCzkGq0wmSAuRs7EBFg',  // Miniminuteman
                'UCehBVAPy-bxmnbNARF-_tvA',  // More Perfect Union
                'UCl05spNa1YKRfSnQyIdCxfg',  // The Cozy Creative
                'UCbRP3c757lWg9M-U7TyEkXA',  // Theo - t3‚Ä§gg
                'UChpleBmo18P08aKCIgti38g',  // Matt Wolfe
                'UCqcbQf6yw5KzRoDDcZ_wBSw',  // Wes Roth
                'UC5l7RouTQ60oUjLjt1Nh-UQ',  // AI Revolution
                'UCIHKqzULI6b8yrfOV3uCx7A',  // endeavorance
                'UClFSU9_bUb4Rc6OYfTt5SPw',  // Philip DeFranco
                'UC4e3Gm46D6hWqVyjwkgS33g',  // Under The Desk News
                'UCpa-Zb0ZcQjTCPP1Dx_1M8Q',  // LegalEagle
                'UCwWhs_6x42TyRM4Wstoq8HA',  // The Daily Show
                'UCMtFAi84ehTSYSE9XoHefig',  // The Late Show with Stephen Colbert
                'UCJHAT3Uvv-g3I8H3GhHWV7w',  // Ryan Hall, Y'all
                'UCT6Y5JJPKe_JDMivpKgVXew',  // Fall of Civilizations
                'UC22uGvImj3o7m9Zf11jEDkg',  // Cambrian Chronicles
                'UCUVwT8zcS5Z_rYXnpomlbfg',  // Dan Davis History
                'UCqUCj6qGiqnvSeBZCdfHUmQ',  // Rita Wilkins
                'UCZdWrz8pF6B5Y_c6Zi6pmdQ',  // Decoding the Unknown
                'UCergKLoy-Yv9zlPk3XQYK7Q',  // Crashing Out with Philip DeFranco & Alex Pearlman
            ],

            // Your Substack Newsletter URLs
            substackFeeds: [
                'https://dominiquetaylor.substack.com',
                'https://dannberg.substack.com',
                'https://dhimmimonde.substack.com',
                'https://petersmetanick.substack.com',
                'https://sparrowsendclubhouse.substack.com',
                'https://foxhollowfarm.substack.com',
                'https://rubyleighmccray.substack.com',
                'https://amandanbray.substack.com',
                'https://jessliese.substack.com',
                'https://joyfulordinary.substack.com',
                'https://jtlawrence.substack.com',
                'https://mogginbogginsalmanac.substack.com',
                'https://lewright.substack.com',
                'https://lidiyafoxglove.substack.com',
                'https://tjpatton.substack.com',
                'https://madebyma.substack.com',
                'https://runamukacres.substack.com',
                'https://7figurefiction.substack.com',
                'https://on.substack.com',
                'https://penandprosper.substack.com',
                'https://www.personalcanon.com',
                'https://deeprootscommunity.substack.com',
                'https://thetenderroom.substack.com',
                'https://unfinishedsketchbook.substack.com',
                'https://zyntale.substack.com',
            ],

            // Number of items to show per feed
            maxVideos: 15,
            maxArticles: 15
        };

        // ============================================
        // API KEY MANAGEMENT (localStorage)
        // ============================================

        const API_KEY_STORAGE = 'youtube_api_key';

        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE);
        }

        function setApiKey(key) {
            localStorage.setItem(API_KEY_STORAGE, key);
        }

        function updateApiKeyStatus() {
            const statusEl = document.getElementById('youtube-api-status');
            const apiKey = getApiKey();

            if (apiKey) {
                statusEl.className = 'api-status configured';
                statusEl.textContent = '‚úì API Key Set';
            } else {
                statusEl.className = 'api-status missing';
                statusEl.textContent = '‚ö† No API Key';
            }
        }

        function openApiKeyModal() {
            const currentKey = getApiKey();
            document.getElementById('apiKey').value = currentKey || '';
            document.getElementById('apiKeyModal').classList.add('active');
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('active');
        }

        document.getElementById('apiKeyForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const key = document.getElementById('apiKey').value.trim();

            if (key) {
                setApiKey(key);
                updateApiKeyStatus();
                closeApiKeyModal();
                // Reload YouTube content with new key
                fetchYouTubeVideos();
            }
        });

        // Close API modal when clicking outside
        document.getElementById('apiKeyModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeApiKeyModal();
            }
        });

        // ============================================
        // YOUTUBE CACHING SYSTEM
        // ============================================

        const CACHE_KEYS = {
            videos: 'youtube_cache_videos',
            timestamp: 'youtube_cache_timestamp',
            refreshCount: 'youtube_refresh_count',
            refreshDate: 'youtube_refresh_date'
        };

        const CACHE_MAX_AGE_HOURS = 24;
        const MAX_DAILY_REFRESHES = 3;

        // Get current date in Pacific timezone for quota reset alignment
        // YouTube quota resets at midnight Pacific (3 AM Eastern)
        function getPacificDateString() {
            const now = new Date();
            // Get Pacific time by using toLocaleString with timezone
            const pacificString = now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });
            const pacificDate = new Date(pacificString);
            return pacificDate.toDateString();
        }

        function saveToCache(videos) {
            localStorage.setItem(CACHE_KEYS.videos, JSON.stringify(videos));
            localStorage.setItem(CACHE_KEYS.timestamp, Date.now().toString());
        }

        function loadFromCache() {
            const cached = localStorage.getItem(CACHE_KEYS.videos);
            return cached ? JSON.parse(cached) : null;
        }

        function getCacheTimestamp() {
            const ts = localStorage.getItem(CACHE_KEYS.timestamp);
            return ts ? parseInt(ts, 10) : null;
        }

        function getCacheAgeHours() {
            const timestamp = getCacheTimestamp();
            if (!timestamp) return Infinity;
            return (Date.now() - timestamp) / (1000 * 60 * 60);
        }

        function isCacheValid() {
            const videos = loadFromCache();
            const ageHours = getCacheAgeHours();
            return videos && videos.length > 0 && ageHours < CACHE_MAX_AGE_HOURS;
        }

        function getRefreshCount() {
            const savedDate = localStorage.getItem(CACHE_KEYS.refreshDate);
            const currentPacificDate = getPacificDateString();

            // Reset counter if it's a new day in Pacific time
            if (savedDate !== currentPacificDate) {
                localStorage.setItem(CACHE_KEYS.refreshDate, currentPacificDate);
                localStorage.setItem(CACHE_KEYS.refreshCount, '0');
                return 0;
            }

            return parseInt(localStorage.getItem(CACHE_KEYS.refreshCount) || '0', 10);
        }

        function incrementRefreshCount() {
            const currentPacificDate = getPacificDateString();
            localStorage.setItem(CACHE_KEYS.refreshDate, currentPacificDate);
            const newCount = getRefreshCount() + 1;
            localStorage.setItem(CACHE_KEYS.refreshCount, newCount.toString());
            return newCount;
        }

        function formatCacheAge(timestamp) {
            if (!timestamp) return 'Never';

            const ageMs = Date.now() - timestamp;
            const ageMinutes = Math.floor(ageMs / (1000 * 60));
            const ageHours = Math.floor(ageMs / (1000 * 60 * 60));

            if (ageMinutes < 1) return 'Just now';
            if (ageMinutes < 60) return `${ageMinutes} min ago`;
            if (ageHours < 24) return `${ageHours} hour${ageHours > 1 ? 's' : ''} ago`;
            return `${Math.floor(ageHours / 24)} day${ageHours >= 48 ? 's' : ''} ago`;
        }

        function updateCacheInfo() {
            const cacheTimeEl = document.getElementById('cache-time');
            const refreshCounterEl = document.getElementById('refresh-counter');

            const timestamp = getCacheTimestamp();
            const refreshCount = getRefreshCount();

            cacheTimeEl.textContent = `Last updated: ${formatCacheAge(timestamp)}`;
            refreshCounterEl.textContent = `Refreshes today: ${refreshCount}/${MAX_DAILY_REFRESHES}`;

            if (refreshCount >= MAX_DAILY_REFRESHES) {
                refreshCounterEl.classList.add('warning');
            } else {
                refreshCounterEl.classList.remove('warning');
            }
        }

        // ============================================
        // BOOKS MANAGEMENT (localStorage)
        // ============================================

        let books = JSON.parse(localStorage.getItem('books')) || [];
        let editingIndex = null;

        function renderBooks() {
            const grid = document.getElementById('reading-grid');

            if (books.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <p>No books added yet. Click "Add Book/Audiobook" to get started!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = books.map((book, index) => `
                <div class="book-card" onclick="editBook(${index})">
                    <h3>${book.platform}</h3>
                    <div class="book-title">${book.title}</div>
                    <a href="${book.url}" class="book-link" target="_blank" onclick="event.stopPropagation()">
                        Open Book ‚Üí
                    </a>
                </div>
            `).join('');
        }

        function openBookModal() {
            editingIndex = null;
            document.getElementById('book-modal-title').textContent = 'Add Book/Audiobook';
            document.getElementById('bookForm').reset();
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('bookModal').classList.add('active');
        }

        function editBook(index) {
            editingIndex = index;
            const book = books[index];
            document.getElementById('book-modal-title').textContent = 'Edit Book/Audiobook';
            document.getElementById('platform').value = book.platform;
            document.getElementById('title').value = book.title;
            document.getElementById('url').value = book.url;
            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('bookModal').classList.add('active');
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('active');
        }

        function deleteCurrentBook() {
            if (editingIndex !== null && confirm('Are you sure you want to delete this book?')) {
                books.splice(editingIndex, 1);
                localStorage.setItem('books', JSON.stringify(books));
                closeBookModal();
                renderBooks();
            }
        }

        document.getElementById('bookForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const book = {
                platform: document.getElementById('platform').value,
                title: document.getElementById('title').value,
                url: document.getElementById('url').value
            };

            if (editingIndex !== null) {
                books[editingIndex] = book;
            } else {
                books.push(book);
            }

            localStorage.setItem('books', JSON.stringify(books));
            closeBookModal();
            renderBooks();
        });

        // Close book modal when clicking outside
        document.getElementById('bookModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeBookModal();
            }
        });

        // ============================================
        // YOUTUBE INTEGRATION
        // ============================================

        function renderVideos(videos) {
            const content = document.getElementById('youtube-content');

            if (videos.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>No recent videos found.</p></div>';
            } else {
                content.innerHTML = `
                    <div class="content-grid">
                        ${videos.map(video => `
                            <div class="content-card">
                                <a href="https://www.youtube.com/watch?v=${video.id.videoId}" target="_blank">
                                    <img src="${video.snippet.thumbnails.medium.url}" alt="${video.snippet.title}">
                                    <div class="content-card-body">
                                        <h3>${video.snippet.title}</h3>
                                        <div class="content-meta">
                                            ${video.snippet.channelTitle} ‚Ä¢ ${formatDate(video.snippet.publishedAt)}
                                        </div>
                                    </div>
                                </a>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        async function fetchYouTubeVideos(forceRefresh = false) {
            const content = document.getElementById('youtube-content');
            const refreshBtn = document.getElementById('youtube-refresh');
            const apiKey = getApiKey();

            // Check if API key exists
            if (!apiKey) {
                content.innerHTML = `
                    <div class="empty-state">
                        <p>No YouTube API key configured.</p>
                        <button class="btn btn-primary" onclick="openApiKeyModal()">Set Up API Key</button>
                    </div>
                `;
                updateCacheInfo();
                return;
            }

            // Check cache first (unless forcing refresh)
            if (!forceRefresh && isCacheValid()) {
                const cachedVideos = loadFromCache();
                renderVideos(cachedVideos);
                updateCacheInfo();
                console.log('Loaded videos from cache');
                return;
            }

            // If cache is expired (>24h) and not forcing, auto-refresh silently
            const isAutoRefresh = !forceRefresh && getCacheAgeHours() >= CACHE_MAX_AGE_HOURS;

            refreshBtn.disabled = true;
            content.innerHTML = '<div class="loading">Loading videos...</div>';

            // Increment refresh counter BEFORE making API calls
            // (quota is consumed on request, regardless of success/failure)
            incrementRefreshCount();
            updateCacheInfo();

            try {
                const allVideos = [];

                for (const channelId of CONFIG.youtubeChannels) {
                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?key=${apiKey}&channelId=${channelId}&part=snippet,id&order=date&maxResults=5&type=video`
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('YouTube API Error Details:', errorData);
                        throw new Error(`YouTube API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const data = await response.json();
                    allVideos.push(...data.items);
                }

                // Sort all videos by date
                allVideos.sort((a, b) => new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt));

                // Take top N videos
                const topVideos = allVideos.slice(0, CONFIG.maxVideos);

                // Save to cache
                saveToCache(topVideos);

                renderVideos(topVideos);

            } catch (error) {
                console.error('YouTube fetch error:', error);

                // Try to fall back to cache if available
                const cachedVideos = loadFromCache();
                if (cachedVideos && cachedVideos.length > 0) {
                    renderVideos(cachedVideos);
                    content.innerHTML += `
                        <div class="error" style="margin-top: 15px;">
                            <strong>Note:</strong> Showing cached data. Refresh failed: ${error.message}
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="error">
                            <strong>Error loading YouTube videos:</strong><br>
                            ${error.message}
                        </div>
                    `;
                }
            } finally {
                refreshBtn.disabled = false;
                updateCacheInfo();
            }
        }

        function refreshYouTube() {
            const refreshCount = getRefreshCount();

            if (refreshCount >= MAX_DAILY_REFRESHES) {
                const confirmed = confirm(
                    `‚ö†Ô∏è You've already refreshed ${refreshCount} times today.\n\n` +
                    `YouTube API quota resets at 3 AM Eastern (midnight Pacific).\n\n` +
                    `Refreshing now may use up your daily quota.\n\n` +
                    `Continue anyway?`
                );
                if (!confirmed) return;
            }

            fetchYouTubeVideos(true);
        }

        // ============================================
        // SUBSTACK INTEGRATION
        // ============================================

        async function fetchSubstackArticles() {
            const content = document.getElementById('substack-content');
            const refreshBtn = document.getElementById('substack-refresh');

            refreshBtn.disabled = true;
            content.innerHTML = '<div class="loading">Loading articles... This may take a minute.</div>';

            try {
                const allArticles = [];

                // Fetch feeds one at a time with delays to avoid rate limiting
                for (let i = 0; i < CONFIG.substackFeeds.length; i++) {
                    const feedUrl = CONFIG.substackFeeds[i];

                    // Add a delay between requests (except for the first one)
                    if (i > 0) {
                        await new Promise(resolve => setTimeout(resolve, 500)); // 500ms delay
                    }

                    try {
                        // Use RSS2JSON service to parse RSS feeds (avoids CORS issues)
                        const rssUrl = `${feedUrl}/feed`;
                        const response = await fetch(
                            `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}&count=2`
                        );

                        if (!response.ok) {
                            console.warn(`RSS fetch error for ${feedUrl}: ${response.status}`);
                            continue;
                        }

                        const data = await response.json();

                        if (data.status === 'ok' && data.items) {
                            allArticles.push(...data.items);
                        }
                    } catch (error) {
                        console.warn(`Error fetching ${feedUrl}:`, error);
                    }
                }

                // Sort all articles by date
                allArticles.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

                // Take top N articles
                const topArticles = allArticles.slice(0, CONFIG.maxArticles);

                if (topArticles.length === 0) {
                    content.innerHTML = '<div class="empty-state"><p>No recent articles found.</p></div>';
                } else {
                    content.innerHTML = `
                        <div class="content-grid">
                            ${topArticles.map(article => `
                                <div class="content-card">
                                    <a href="${article.link}" target="_blank">
                                        ${article.thumbnail ? `<img src="${article.thumbnail}" alt="${article.title}">` : ''}
                                        <div class="content-card-body">
                                            <h3>${article.title}</h3>
                                            <div class="content-meta">
                                                ${article.author} ‚Ä¢ ${formatDate(article.pubDate)}
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Substack fetch error:', error);
                content.innerHTML = `
                    <div class="error">
                        <strong>Error loading Substack articles:</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                refreshBtn.disabled = false;
            }
        }

        function refreshSubstack() {
            fetchSubstackArticles();
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        // Update API key status indicator
        updateApiKeyStatus();

        // Update cache info display
        updateCacheInfo();

        // Render books on page load
        renderBooks();

        // Check if API key exists, prompt if not
        if (!getApiKey()) {
            // Show a friendly message instead of immediately popping up modal
            document.getElementById('youtube-content').innerHTML = `
                <div class="empty-state">
                    <p>Welcome! To see your YouTube feed, you'll need to set up your API key.</p>
                    <button class="btn btn-primary" onclick="openApiKeyModal()">Set Up API Key</button>
                </div>
            `;
        } else {
            // Load YouTube content (will use cache if valid, or auto-refresh if >24h old)
            fetchYouTubeVideos();
        }

        // Load Substack content (doesn't need API key)
        fetchSubstackArticles();
    </script>
</body>

</html>